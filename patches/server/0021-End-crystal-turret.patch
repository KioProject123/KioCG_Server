From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Mon, 18 Mar 2024 12:04:58 +0800
Subject: [PATCH] End crystal turret


diff --git a/src/main/java/com/kiocg/java/NamespacedKeys.java b/src/main/java/com/kiocg/java/NamespacedKeys.java
index f2044f27ec933da4620f0623421659bca2daef16..bb51e9f42d823bdc1d77b6afd1c2c7b2071c1693 100644
--- a/src/main/java/com/kiocg/java/NamespacedKeys.java
+++ b/src/main/java/com/kiocg/java/NamespacedKeys.java
@@ -8,4 +8,8 @@ public class NamespacedKeys {
     public static final NamespacedKey kiocgColdValue = new NamespacedKey(KIOCG, "cold_value");
     public static final NamespacedKey kiocgThirstValue = new NamespacedKey(KIOCG, "thirst_value");
     public static final NamespacedKey kiocgThirstRegain = new NamespacedKey(KIOCG, "thirst_regain");
+
+    public static final NamespacedKey kiocgTurretTicks = new NamespacedKey(KIOCG, "turret_ticks");
+    public static final NamespacedKey kiocgTurretRange = new NamespacedKey(KIOCG, "turret_range");
+    public static final NamespacedKey kiocgTurretDamage = new NamespacedKey(KIOCG, "turret_damage");
 }
diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index f4c79dc1b2c40105e14f3a505906c54a1ac7b5ef..2adc4979142f4cb3c511a8a740843f201684066b 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -586,6 +586,10 @@ public class WorldConfiguration extends ConfigurationPart {
         public class Monster extends ConfigurationPart {
             public boolean spawnInLightAtNight = true;
             public int darkEnoughToSprint = 7;
+            public boolean endCrystalTurret = true;
+            public int turretTicks = 100;
+            public double turretRange = 8.0;
+            public double turretDamage = 1.0;
         }
 
         public boolean betterMobGriefingSetting = true;
diff --git a/src/main/java/net/minecraft/world/entity/boss/enderdragon/EndCrystal.java b/src/main/java/net/minecraft/world/entity/boss/enderdragon/EndCrystal.java
index 036640d49a5e891e9a0f767abe33f1f51d6d4cde..7046138da6d08265c6f6c262a954427a736c2a68 100644
--- a/src/main/java/net/minecraft/world/entity/boss/enderdragon/EndCrystal.java
+++ b/src/main/java/net/minecraft/world/entity/boss/enderdragon/EndCrystal.java
@@ -31,6 +31,10 @@ public class EndCrystal extends Entity {
     private static final EntityDataAccessor<Boolean> DATA_SHOW_BOTTOM = SynchedEntityData.defineId(EndCrystal.class, EntityDataSerializers.BOOLEAN);
     public int time;
     public boolean generatedByDragonFight = false; // Paper - Fix invulnerable end crystals
+    // KioCG start
+    private int idleCooldown = 0;
+    private int beamTicks = 0;
+    // KioCG end
 
     public EndCrystal(EntityType<? extends EndCrystal> type, Level world) {
         super(type, world);
@@ -78,6 +82,37 @@ public class EndCrystal extends Entity {
                 }
             }
             // Paper end - Fix invulnerable end crystals
+            // KioCG start
+            if (this.level().paperConfig().kiocgConfig.monster.endCrystalTurret && !this.generatedByDragonFight) {
+                if (--beamTicks <= 0) {
+                    setBeamTarget(null);
+                }
+
+                if (--idleCooldown <= 0) {
+                    idleCooldown = this.getBukkitEntity().getPersistentDataContainer().getOrDefault(com.kiocg.java.NamespacedKeys.kiocgTurretTicks, org.bukkit.persistence.PersistentDataType.INTEGER, this.level().paperConfig().kiocgConfig.monster.turretTicks);
+                    destroyTarget();
+                }
+            }
+        }
+    }
+
+    private void destroyTarget() {
+        double range = this.getBukkitEntity().getPersistentDataContainer().getOrDefault(com.kiocg.java.NamespacedKeys.kiocgTurretRange, org.bukkit.persistence.PersistentDataType.DOUBLE, this.level().paperConfig().kiocgConfig.monster.turretRange);
+        java.util.List<net.minecraft.world.entity.monster.Monster> list1 = this.level().getEntitiesOfClass(net.minecraft.world.entity.monster.Monster.class, this.getBoundingBox().inflate(range), (entityliving1) -> {
+            return entityliving1.isAlive() && entityliving1.hasLineOfSight(this);
+        });
+
+        if (!list1.isEmpty()) {
+            net.minecraft.world.entity.LivingEntity entityliving = list1.get(this.level().random.nextInt(list1.size()));
+
+            double damage = this.getBukkitEntity().getPersistentDataContainer().getOrDefault(com.kiocg.java.NamespacedKeys.kiocgTurretDamage, org.bukkit.persistence.PersistentDataType.DOUBLE, this.level().paperConfig().kiocgConfig.monster.turretDamage);
+            if (entityliving.hurt(this.level().damageSources().indirectMagic(this, this), (float) damage)) {
+                this.level().playSound(null, this.blockPosition(), net.minecraft.sounds.SoundEvents.TRIDENT_THROW, net.minecraft.sounds.SoundSource.BLOCKS, 1.0F, 2.0F);
+            }
+
+            setBeamTarget(entityliving.blockPosition().atY((int) entityliving.getEyeY()).offset(0, -2, 0));
+            beamTicks = 4;
+            // KioCG end
         }
 
     }
