From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Sun, 24 Mar 2024 16:55:50 +0800
Subject: [PATCH] Lead can place anywhere


diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index c406c2784cfc14761a13dfd70a77e67d99c614ff..d9617bc6f16e576cfa683c877ad89e03666180d8 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -600,6 +600,7 @@ public class WorldConfiguration extends ConfigurationPart {
         public boolean flowersAndGrassesSpreadNaturally = true;
         public boolean sleepAnyTime = true;
         public double sleepHealingRegenRate = 20;
+        public boolean leadCanPlaceAnywhere = true;
     }
     // KioCG end
 }
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index 2ea31c46c8be7cd84e0f9dd78a6f9e3d88f9409d..37f7aa86b87c7ddbc38c7fb839ebab1314064a3f 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -1520,6 +1520,12 @@ public abstract class Mob extends LivingEntity implements Targeting {
             if (!this.level().isClientSide && sendPacket && this.level() instanceof ServerLevel) {
                 ((ServerLevel) this.level()).getChunkSource().broadcast(this, new ClientboundSetEntityLinkPacket(this, (Entity) null));
             }
+
+            // KioCG start
+            if (this.getTags().contains("KioCG_FakeLeash")) {
+                this.discard();
+            }
+            // KioCG end
         }
 
     }
diff --git a/src/main/java/net/minecraft/world/item/LeadItem.java b/src/main/java/net/minecraft/world/item/LeadItem.java
index 379aecea956e28a1da09bc37244e5d8665c714b3..458463e173694b309d2a4668a167bd62ea274e37 100644
--- a/src/main/java/net/minecraft/world/item/LeadItem.java
+++ b/src/main/java/net/minecraft/world/item/LeadItem.java
@@ -35,15 +35,54 @@ public class LeadItem extends Item {
             Player entityhuman = context.getPlayer();
 
             if (!world.isClientSide && entityhuman != null) {
+                InteractionResult result = // KioCG
                 LeadItem.bindPlayerMobs(entityhuman, world, blockposition, context.getHand()); // CraftBukkit - Pass hand
+                if (!result.consumesAction() && spawnFakeLeash(entityhuman, world, blockposition)) context.getItemInHand().shrink(1); // KioCG
             }
 
             return InteractionResult.sidedSuccess(world.isClientSide);
         } else {
+            // KioCG start
+            Player entityhuman = context.getPlayer();
+            if (entityhuman != null && spawnFakeLeash(entityhuman, world, blockposition)) {
+                context.getItemInHand().shrink(1);
+                return InteractionResult.CONSUME;
+            }
+            // KioCG end
+
             return InteractionResult.PASS;
         }
     }
 
+    // KioCG start
+    private static boolean spawnFakeLeash(Player entityhuman, Level world, BlockPos blockposition) {
+        if (!world.paperConfig().kiocgConfig.leadCanPlaceAnywhere) return false;
+        double i = blockposition.getX() + 0.5D;
+        double j = blockposition.getY() + 0.5D;
+        double k = blockposition.getZ() + 0.5D;
+        List<Mob> list = world.getEntitiesOfClass(Mob.class, new AABB((double) i - 0.25D, (double) j - 0.25D, (double) k - 0.25D, (double) i + 0.25D, (double) j + 0.25D, (double) k + 0.25D), entity -> {
+            return entity.getTags().contains("KioCG_FakeLeash");
+        });
+        if (list.size() >= 4) {
+            return false;
+        }
+
+        Mob rabbit = net.minecraft.world.entity.EntityType.RABBIT.create(world);
+        if (rabbit != null) {
+            rabbit.moveTo(blockposition.getCenter());
+            rabbit.setBaby(true);
+            rabbit.setNoAi(true);
+            rabbit.getBukkitMob().setInvisible(true);
+            rabbit.setInvulnerable(true);
+            rabbit.addTag("KioCG_FakeLeash");
+            rabbit.setLeashedTo(entityhuman, true);
+            world.addFreshEntity(rabbit);
+            return true;
+        }
+        return false;
+    }
+    // KioCG end
+
     public static InteractionResult bindPlayerMobs(Player entityhuman, Level world, BlockPos blockposition, net.minecraft.world.InteractionHand enumhand) { // CraftBukkit - Add EnumHand
         LeashFenceKnotEntity entityleash = null;
         boolean flag = false;
