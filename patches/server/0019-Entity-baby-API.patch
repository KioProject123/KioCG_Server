From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Tue, 28 May 2024 15:02:18 +0800
Subject: [PATCH] Entity baby API


diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index 629b9c3dee73dfbddad96187f83e7f4568a1a2d7..1aa6f1afe6249ce616a3470b53ae0fccffa27979 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -580,6 +580,18 @@ public class WorldConfiguration extends ConfigurationPart {
             public int campfireExtinguishingOne = -1;
             public int campfireExtinguishingTwo = -1;
         }
+
+        public Entity entity;
+        public class Entity extends ConfigurationPart {
+            public Reference2IntMap<EntityType<?>> sizeScalingBaby = Util.make(new Reference2IntOpenHashMap<>(BuiltInRegistries.ENTITY_TYPE.size()), map -> {
+                map.defaultReturnValue(50);
+                map.put(EntityType.SKELETON, 65);
+            });
+            public Reference2IntMap<EntityType<?>> sizeScalingHuge = Util.make(new Reference2IntOpenHashMap<>(BuiltInRegistries.ENTITY_TYPE.size()), map -> {
+                map.defaultReturnValue(200);
+                map.put(EntityType.SKELETON, 200);
+            });
+        }
     }
     // KioCG end
 }
diff --git a/src/main/java/net/minecraft/world/entity/AgeableMob.java b/src/main/java/net/minecraft/world/entity/AgeableMob.java
index 3dc3609d13a7b823d15384d1c385b68eeb933d26..7a61d82039a4793f090c928189c01c4df66a7ede 100644
--- a/src/main/java/net/minecraft/world/entity/AgeableMob.java
+++ b/src/main/java/net/minecraft/world/entity/AgeableMob.java
@@ -197,6 +197,7 @@ public abstract class AgeableMob extends PathfinderMob {
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
         this.setAge(baby ? -24000 : 0);
     }
 
diff --git a/src/main/java/net/minecraft/world/entity/LivingEntity.java b/src/main/java/net/minecraft/world/entity/LivingEntity.java
index 5d37ce6e45e818bc5d1a7094b581b097dc0ed80c..63aefefcf566023236444d9229cda3babdfb803f 100644
--- a/src/main/java/net/minecraft/world/entity/LivingEntity.java
+++ b/src/main/java/net/minecraft/world/entity/LivingEntity.java
@@ -286,6 +286,11 @@ public abstract class LivingEntity extends Entity implements Attackable {
     public org.bukkit.craftbukkit.entity.CraftLivingEntity getBukkitLivingEntity() { return (org.bukkit.craftbukkit.entity.CraftLivingEntity) super.getBukkitEntity(); } // Paper
     public boolean silentDeath = false; // Paper - mark entity as dying silently for cancellable death event
     public net.kyori.adventure.util.TriState frictionState = net.kyori.adventure.util.TriState.NOT_SET; // Paper - Friction API
+    // KioCG start
+    private ScaleSimulate scaleSimulate = ScaleSimulate.NORMAL;
+    private final AttributeModifier SCALE_MODIFIER_BABY = new AttributeModifier(ResourceLocation.withDefaultNamespace("scale_simulate"), (this.level().paperConfig().kiocgConfig.entity.sizeScalingBaby.getOrDefault(this.getType(), 50) - 100) / 100.0, AttributeModifier.Operation.ADD_MULTIPLIED_TOTAL);
+    private final AttributeModifier SCALE_MODIFIER_HUGE = new AttributeModifier(ResourceLocation.withDefaultNamespace("scale_simulate"), (this.level().paperConfig().kiocgConfig.entity.sizeScalingHuge.getOrDefault(this.getType(), 200) - 100) / 100.0, AttributeModifier.Operation.ADD_MULTIPLIED_TOTAL);
+    // KioCG end
 
     @Override
     public float getBukkitYaw() {
@@ -592,6 +597,73 @@ public abstract class LivingEntity extends Entity implements Attackable {
         return false;
     }
 
+    // KioCG start
+    public void setScaleSimulate(ScaleSimulate scale) {
+        switch (scale) {
+            case BABY -> {
+                if (this instanceof Mob mob) {
+                    mob.setBaby(true);
+                }
+                if (isBaby()) return; // Vanilla baby
+
+                this.scaleSimulate = scale;
+                AttributeInstance attributemodifiable = this.getAttribute(Attributes.SCALE);
+                attributemodifiable.addOrUpdateTransientModifier(this.SCALE_MODIFIER_BABY);
+            }
+            case HUGE -> {
+                if (this instanceof Mob mob) {
+                    mob.setBaby(false);
+                }
+
+                this.scaleSimulate = scale;
+                AttributeInstance attributemodifiable = this.getAttribute(Attributes.SCALE);
+                attributemodifiable.addOrUpdateTransientModifier(this.SCALE_MODIFIER_HUGE);
+            }
+            default -> {
+                this.scaleSimulate = ScaleSimulate.NORMAL;
+                AttributeInstance attributemodifiable = this.getAttribute(Attributes.SCALE);
+                attributemodifiable.removeModifier(this.SCALE_MODIFIER_BABY.id()); // SCALE_MODIFIER_BABY 和 SCALE_MODIFIER_HUGE 使用相同的ID
+            }
+        }
+    }
+
+    public void setBabySimulateOrVanilla() {
+        this.setScaleSimulate(ScaleSimulate.BABY);
+    }
+
+    public boolean isBabySimulateOrVanilla() {
+        return this.scaleSimulate == ScaleSimulate.BABY || this.isBaby();
+    }
+
+    public void setHugeSimulate() {
+        this.setScaleSimulate(ScaleSimulate.HUGE);
+    }
+
+    public boolean isHugeSimulate() {
+        return this.scaleSimulate == ScaleSimulate.HUGE;
+    }
+
+    public void removeScaleAttributes() {
+        this.setScaleSimulate(ScaleSimulate.NORMAL);
+    }
+
+    public void transformScaleSimulate(LivingEntity original) {
+        if (original.isBabySimulateOrVanilla()) {
+            setBabySimulateOrVanilla();
+        } else if (original.isHugeSimulate()) {
+            setHugeSimulate();
+        } else {
+            removeScaleAttributes();
+        }
+    }
+
+    private enum ScaleSimulate {
+        BABY,
+        HUGE,
+        NORMAL
+    }
+    // KioCG end
+
     public float getAgeScale() {
         return this.isBaby() ? 0.5F : 1.0F;
     }
@@ -812,6 +884,12 @@ public abstract class LivingEntity extends Entity implements Attackable {
         dataresult.resultOrPartial(logger::error).ifPresent((nbtbase) -> {
             nbt.put("Brain", nbtbase);
         });
+
+        // KioCG start
+        if (this.scaleSimulate != ScaleSimulate.NORMAL) {
+            nbt.putString("KioCG.ScaleSimulate", this.scaleSimulate.toString());
+        }
+        // KioCG end
     }
 
     @Override
@@ -900,6 +978,16 @@ public abstract class LivingEntity extends Entity implements Attackable {
             this.brain = this.makeBrain(new Dynamic(NbtOps.INSTANCE, nbt.get("Brain")));
         }
 
+        // KioCG start
+        if (nbt.contains("KioCG.ScaleSimulate")) {
+            String ss = nbt.getString("KioCG.ScaleSimulate");
+            try {
+                this.scaleSimulate = ScaleSimulate.valueOf(ss);
+            } catch (Exception ignored) {
+                LOGGER.error("Unknown scale simulate " + ss + " for " + this);
+            }
+        }
+        // KioCG end
     }
 
     // CraftBukkit start
@@ -2730,7 +2818,7 @@ public abstract class LivingEntity extends Entity implements Attackable {
     }
 
     public float getVoicePitch() {
-        return this.isBaby() ? (this.random.nextFloat() - this.random.nextFloat()) * 0.2F + 1.5F : (this.random.nextFloat() - this.random.nextFloat()) * 0.2F + 1.0F;
+        return this.isBabySimulateOrVanilla() ? (this.random.nextFloat() - this.random.nextFloat()) * 0.2F + 1.5F : (this.random.nextFloat() - this.random.nextFloat()) * 0.2F + 1.0F; // KioCG
     }
 
     protected boolean isImmobile() {
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index 1824d2b10bc0ea64234ab42896ce8fd1d3001ef7..82a5a5d944651a0a81ea2518dc060dba0af23794 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -1690,7 +1690,7 @@ public abstract class Mob extends LivingEntity implements EquipmentUser, Leashab
         return ((Byte) this.entityData.get(Mob.DATA_MOB_FLAGS_ID) & 4) != 0;
     }
 
-    public void setBaby(boolean baby) {}
+    public void setBaby(boolean baby) { if(baby){removeScaleAttributes();} } // KioCG - add removeScaleAttributes()
 
     @Override
     public HumanoidArm getMainArm() {
diff --git a/src/main/java/net/minecraft/world/entity/animal/frog/Frog.java b/src/main/java/net/minecraft/world/entity/animal/frog/Frog.java
index 816977990639ec0559b652fc9666afd5046f0a5d..65913849fdf400a34d8a66aade80714b605b9660 100644
--- a/src/main/java/net/minecraft/world/entity/animal/frog/Frog.java
+++ b/src/main/java/net/minecraft/world/entity/animal/frog/Frog.java
@@ -257,6 +257,7 @@ public class Frog extends Animal implements VariantHolder<Holder<FrogVariant>> {
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/world/entity/animal/sniffer/Sniffer.java b/src/main/java/net/minecraft/world/entity/animal/sniffer/Sniffer.java
index fadd341ff398886a4da102eefa1beb95a63bbd6d..4da9c658e367dd2099e0391e1360e3ca56bdc0ed 100644
--- a/src/main/java/net/minecraft/world/entity/animal/sniffer/Sniffer.java
+++ b/src/main/java/net/minecraft/world/entity/animal/sniffer/Sniffer.java
@@ -431,6 +431,7 @@ public class Sniffer extends Animal {
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
         this.setAge(baby ? -48000 : 0);
     }
 
diff --git a/src/main/java/net/minecraft/world/entity/monster/Zoglin.java b/src/main/java/net/minecraft/world/entity/monster/Zoglin.java
index aa458ede5bd645ebf524238179edb33f41bd683f..3c36037bb856720acaf951a83fe1f64a465c77e5 100644
--- a/src/main/java/net/minecraft/world/entity/monster/Zoglin.java
+++ b/src/main/java/net/minecraft/world/entity/monster/Zoglin.java
@@ -241,10 +241,16 @@ public class Zoglin extends Monster implements Enemy, HoglinBase {
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
         this.getEntityData().set(DATA_BABY_ID, baby);
         if (!this.level().isClientSide && baby) {
             this.getAttribute(Attributes.ATTACK_DAMAGE).setBaseValue(0.5);
         }
+        // KioCG start
+        if (!this.level().isClientSide && !baby) {
+            this.getAttribute(Attributes.ATTACK_DAMAGE).setBaseValue(ATTACK_DAMAGE);
+        }
+        // KioCG end
     }
 
     @Override
diff --git a/src/main/java/net/minecraft/world/entity/monster/Zombie.java b/src/main/java/net/minecraft/world/entity/monster/Zombie.java
index 892f02475976203abdd472aa02b80a9bfe48f752..8c180d6286cda99a7fd656eab588f55584e6e10f 100644
--- a/src/main/java/net/minecraft/world/entity/monster/Zombie.java
+++ b/src/main/java/net/minecraft/world/entity/monster/Zombie.java
@@ -190,6 +190,7 @@ public class Zombie extends Monster {
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
         this.getEntityData().set(Zombie.DATA_BABY_ID, baby);
         if (this.level() != null && !this.level().isClientSide) {
             AttributeInstance attributemodifiable = this.getAttribute(Attributes.MOVEMENT_SPEED);
diff --git a/src/main/java/net/minecraft/world/entity/monster/piglin/Piglin.java b/src/main/java/net/minecraft/world/entity/monster/piglin/Piglin.java
index bc58323801ee16fe9b63c21332144ec002a902f2..06cd00d571d583b9b94f3fb703e084fcde67391b 100644
--- a/src/main/java/net/minecraft/world/entity/monster/piglin/Piglin.java
+++ b/src/main/java/net/minecraft/world/entity/monster/piglin/Piglin.java
@@ -267,6 +267,7 @@ public class Piglin extends AbstractPiglin implements CrossbowAttackMob, Invento
 
     @Override
     public void setBaby(boolean baby) {
+        if (baby) removeScaleAttributes(); // KioCG
         this.getEntityData().set(Piglin.DATA_BABY_ID, baby);
         if (!this.level().isClientSide) {
             AttributeInstance attributemodifiable = this.getAttribute(Attributes.MOVEMENT_SPEED);
diff --git a/src/main/java/net/minecraft/world/item/SpawnEggItem.java b/src/main/java/net/minecraft/world/item/SpawnEggItem.java
index 9cea8da84f39bb3f687139ef213ccea358724dee..12e150829358c2ae407891e11c28a3d1b25cb6b3 100644
--- a/src/main/java/net/minecraft/world/item/SpawnEggItem.java
+++ b/src/main/java/net/minecraft/world/item/SpawnEggItem.java
@@ -174,8 +174,10 @@ public class SpawnEggItem extends Item {
             if (object == null) {
                 return Optional.empty();
             } else {
-                ((Mob) object).setBaby(true);
-                if (!((Mob) object).isBaby()) {
+                // KioCG start
+                ((Mob) object).setBabySimulateOrVanilla();
+                if (false && !((Mob) object).isBaby()) {
+                // KioCG end
                     return Optional.empty();
                 } else {
                     ((Mob) object).moveTo(pos.x(), pos.y(), pos.z(), 0.0F, 0.0F);
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
index d2bb0831394c03b620b2cbd8306cb82b621f34f7..f71f4eaea20a3a799e775416da158589e8726134 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
@@ -1189,4 +1189,31 @@ public class CraftLivingEntity extends CraftEntity implements LivingEntity {
         return this.getHandle().canUseSlot(org.bukkit.craftbukkit.CraftEquipmentSlot.getNMS(slot));
     }
     // Paper end - Expose canUseSlot
+
+    // KioCG start
+    @Override
+    public void setBabySimulateOrVanilla() {
+        getHandle().setBabySimulateOrVanilla();
+    }
+
+    @Override
+    public boolean isBabySimulateOrVanilla() {
+        return getHandle().isBabySimulateOrVanilla();
+    }
+
+    @Override
+    public void setHugeSimulate() {
+        getHandle().setHugeSimulate();
+    }
+
+    @Override
+    public boolean isHugeSimulate() {
+        return getHandle().isHugeSimulate();
+    }
+
+    @Override
+    public void removeScaleAttributes() {
+        getHandle().removeScaleAttributes();
+    }
+    // KioCG end
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 7cfec96bddb2731baac6a8b7909c4a13d94d8794..5ed949083cd1e01b3d97713de0937fbee8ab4c3d 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -609,6 +609,7 @@ public class CraftEventFactory {
     public static EntityTransformEvent callEntityTransformEvent(net.minecraft.world.entity.LivingEntity original, List<net.minecraft.world.entity.LivingEntity> convertedList, EntityTransformEvent.TransformReason convertType) {
         List<org.bukkit.entity.Entity> list = new ArrayList<>();
         for (net.minecraft.world.entity.LivingEntity entityLiving : convertedList) {
+            entityLiving.transformScaleSimulate(original); // KioCG
             list.add(entityLiving.getBukkitEntity());
         }
 
@@ -1337,6 +1338,7 @@ public class CraftEventFactory {
     }
 
     public static PigZapEvent callPigZapEvent(Entity pig, Entity lightning, Entity pigzombie) {
+        ((net.minecraft.world.entity.LivingEntity) pigzombie).transformScaleSimulate((net.minecraft.world.entity.LivingEntity) pig); // KioCG
         PigZapEvent event = new PigZapEvent((Pig) pig.getBukkitEntity(), (LightningStrike) lightning.getBukkitEntity(), (PigZombie) pigzombie.getBukkitEntity());
         pig.getBukkitEntity().getServer().getPluginManager().callEvent(event);
         return event;
