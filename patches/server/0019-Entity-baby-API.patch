From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Tue, 28 May 2024 15:02:18 +0800
Subject: [PATCH] Entity baby API


diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index 629b9c3dee73dfbddad96187f83e7f4568a1a2d7..d5df5ccada65071b5e8ed985e87865c23c46909e 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -580,6 +580,14 @@ public class WorldConfiguration extends ConfigurationPart {
             public int campfireExtinguishingOne = -1;
             public int campfireExtinguishingTwo = -1;
         }
+
+        public Entity entity;
+        public class Entity extends ConfigurationPart {
+            public Reference2IntMap<EntityType<?>> babySizeScaling = Util.make(new Reference2IntOpenHashMap<>(BuiltInRegistries.ENTITY_TYPE.size()), map -> {
+                map.defaultReturnValue(-45);
+                map.put(EntityType.SKELETON, -45);
+            });
+        }
     }
     // KioCG end
 }
diff --git a/src/main/java/net/minecraft/world/entity/Mob.java b/src/main/java/net/minecraft/world/entity/Mob.java
index 1824d2b10bc0ea64234ab42896ce8fd1d3001ef7..cdcf44804e6ed42aaf4acc3688dbd8b24f927b30 100644
--- a/src/main/java/net/minecraft/world/entity/Mob.java
+++ b/src/main/java/net/minecraft/world/entity/Mob.java
@@ -146,6 +146,10 @@ public abstract class Mob extends LivingEntity implements EquipmentUser, Leashab
     private BlockPos restrictCenter;
     private float restrictRadius;
     @Nullable private net.minecraft.server.level.ServerBossEvent bossbar; // KioCG
+    // KioCG start
+    private static final ResourceLocation SCALE_MODIFIER_BABY_ID = ResourceLocation.withDefaultNamespace("baby");
+    private final AttributeModifier SCALE_MODIFIER_BABY = new AttributeModifier(Mob.SCALE_MODIFIER_BABY_ID, this.level().paperConfig().kiocgConfig.entity.babySizeScaling.getInt(this.getType()) / 100, AttributeModifier.Operation.ADD_MULTIPLIED_TOTAL);
+    // KioCG end
 
     public boolean aware = true; // CraftBukkit
 
@@ -1690,7 +1693,23 @@ public abstract class Mob extends LivingEntity implements EquipmentUser, Leashab
         return ((Byte) this.entityData.get(Mob.DATA_MOB_FLAGS_ID) & 4) != 0;
     }
 
-    public void setBaby(boolean baby) {}
+    // KioCG start
+    public void setBaby(boolean baby) {
+        net.minecraft.world.entity.ai.attributes.AttributeInstance attributemodifiable = this.getAttribute(Attributes.SCALE);
+
+        if (attributemodifiable != null) {
+            attributemodifiable.removeModifier(Mob.SCALE_MODIFIER_BABY_ID);
+            if (baby) {
+                attributemodifiable.addPermanentModifier(this.SCALE_MODIFIER_BABY);
+            }
+        }
+    }
+
+    public boolean isBaby() {
+        net.minecraft.world.entity.ai.attributes.AttributeInstance attributemodifiable = this.getAttribute(Attributes.SCALE);
+        return attributemodifiable != null && attributemodifiable.getModifier(Mob.SCALE_MODIFIER_BABY_ID) != null;
+    }
+    // KioCG end
 
     @Override
     public HumanoidArm getMainArm() {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftMob.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftMob.java
index 6476349ef9759a9b471472f69d3545376d1dd17f..445a9f6a9a8d6099649d96374c40ba95030826f4 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftMob.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftMob.java
@@ -187,4 +187,16 @@ public abstract class CraftMob extends CraftLivingEntity implements Mob {
         getHandle().setBossBar(((org.bukkit.craftbukkit.boss.CraftBossBar) bossbar).getHandle());
     }
     // KioCG end
+
+    // KioCG start
+    @Override
+    public boolean isBaby() {
+        return getHandle().isBaby();
+    }
+
+    @Override
+    public void setBaby(boolean flag) {
+        getHandle().setBaby(flag);
+    }
+    // KioCG end
 }
