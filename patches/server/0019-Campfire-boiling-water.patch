From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Tue, 23 Jul 2024 16:56:25 +0800
Subject: [PATCH] Campfire boiling water


diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index 40a4317a8ee4d8c98e2801d706661980afa29c9c..127f0369f70cd2b80bd8f69ff43f99e929389698 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -614,6 +614,8 @@ public class WorldConfiguration extends ConfigurationPart {
                 public double thirstRegainMultiplierFood = 2.0;
                 public double highTemperatureBiomeThirst = 0.02;
             }
+
+            public int campfireBoilingWaterTime = 600;
         }
     }
     // KioCG end
diff --git a/src/main/java/net/minecraft/world/level/block/LayeredCauldronBlock.java b/src/main/java/net/minecraft/world/level/block/LayeredCauldronBlock.java
index 66dabb34eb4dfdd526ee1800d04aeda0cc99fcda..098fcb24a5174c173c57bfdd9afb5fb8227c4968 100644
--- a/src/main/java/net/minecraft/world/level/block/LayeredCauldronBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/LayeredCauldronBlock.java
@@ -131,6 +131,19 @@ public class LayeredCauldronBlock extends AbstractCauldronBlock {
         if (event.isCancelled()) {
             return false;
         }
+
+        // KioCG start
+        final net.minecraft.world.level.block.entity.BlockEntity blockEntity = world.getBlockEntity(blockposition.below());
+        if (blockEntity instanceof net.minecraft.world.level.block.entity.CampfireBlockEntity campfireBlockEntity) {
+            final int oldLevel = event.getBlock().getBlockData() instanceof org.bukkit.block.data.Levelled oldLevelled ? oldLevelled.getLevel() : 0;
+            final int newLevel = event.getNewState().getBlockData() instanceof org.bukkit.block.data.Levelled newLevelled ? newLevelled.getLevel() : 0;
+            // 根本不关心岩浆
+            if (oldLevel != newLevel) {
+                campfireBlockEntity.cauldronLevelChanged(oldLevel, newLevel);
+            }
+        }
+        // KioCG end
+
         newState.update(true);
         if (sendGameEvent) world.gameEvent((Holder) GameEvent.BLOCK_CHANGE, blockposition, GameEvent.Context.of(newBlock)); // Paper - Call CauldronLevelChangeEvent
         return true;
diff --git a/src/main/java/net/minecraft/world/level/block/entity/CampfireBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/CampfireBlockEntity.java
index 20d4cda6396601621b684f6048afffba650598bf..59b948e68dac37856eaf66572fed3842d95d8419 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/CampfireBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/CampfireBlockEntity.java
@@ -47,6 +47,7 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
     public final int[] cookingTime;
     private final RecipeManager.CachedCheck<SingleRecipeInput, CampfireCookingRecipe> quickCheck;
     public final boolean[] stopCooking; // Paper - Add more Campfire API
+    private int cauldronTemperature = 0; // KioCG
 
     public CampfireBlockEntity(BlockPos pos, BlockState state) {
         super(BlockEntityType.CAMPFIRE, pos, state);
@@ -134,6 +135,35 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
             }
         }
 
+        // KioCG start
+        BlockPos above = pos.above();
+        BlockState aboveState = world.getBlockState(above);
+        if (aboveState.is(net.minecraft.world.level.block.Blocks.WATER_CAULDRON)) {
+            if (!campfire.isCauldronBoiling()) {
+                Integer level = aboveState.getValue(net.minecraft.world.level.block.LayeredCauldronBlock.LEVEL);
+                campfire.cauldronTemperature = Math.min(campfire.cauldronTemperature + switch (level) {
+                    case 1 -> 3;
+                    case 2 -> 2;
+                    case 3 -> 1;
+                    default -> throw new IllegalStateException("Unexpected value: " + level);
+                }, world.paperConfig().kiocgConfig.theLongDark.campfireBoilingWaterTime);
+                flag = true;
+            } else {
+                if (world.getRandom().nextDouble() < 0.1) {
+                    world.playSound(null, above, net.minecraft.sounds.SoundEvents.POINTED_DRIPSTONE_DRIP_WATER_INTO_CAULDRON, net.minecraft.sounds.SoundSource.BLOCKS, 1.0F, 0.1F);
+                }
+
+                double x = (double) above.getX() + 0.5;
+                double y = (double) above.getY() + 1.0;
+                double z = (double) above.getZ() + 0.5;
+                ((net.minecraft.server.level.ServerLevel) world).sendParticles(ParticleTypes.FALLING_WATER, x, y, z, 10, 0.25, 0.1, 0.25, 1.0);
+            }
+        } else if (campfire.cauldronTemperature > 0) {
+            campfire.cauldronTemperature = 0;
+            flag = true;
+        }
+        // KioCG end
+
         if (flag) {
             setChanged(world, pos, state);
         }
@@ -149,6 +179,12 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
                 campfire.cookingProgress[i] = Mth.clamp(campfire.cookingProgress[i] - 2, 0, campfire.cookingTime[i]);
             }
         }
+        // KioCG start
+        if (campfire.cauldronTemperature > 0) {
+            flag = true;
+            campfire.cauldronTemperature = Math.max(0, campfire.cauldronTemperature - 2);
+        }
+        // KioCG end
 
         if (flag) {
             setChanged(world, pos, state);
@@ -166,12 +202,27 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
                 campfire.cookingProgress[i] = (int) 0;
             }
         }
+        if (campfire.cauldronTemperature > 0) {
+            flag = true;
+            campfire.cauldronTemperature = 0;
+        }
 
         if (flag) {
             setChanged(world, pos, state);
         }
 
     }
+
+    public boolean isCauldronBoiling() {
+        return this.cauldronTemperature >= this.level.paperConfig().kiocgConfig.theLongDark.campfireBoilingWaterTime;
+    }
+
+    public void cauldronLevelChanged(int oldLevel, int newLevel) {
+        if (newLevel > oldLevel) {
+            this.cauldronTemperature = (int) ((double) this.cauldronTemperature * oldLevel / newLevel);
+            this.setChanged();
+        }
+    }
     // KioCG end
 
     public static void particleTick(Level world, BlockPos pos, BlockState state, CampfireBlockEntity campfire) {
@@ -233,6 +284,8 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
             System.arraycopy(cookingState, 0, this.stopCooking, 0, Math.min(this.stopCooking.length, abyte.length));
         }
         // Paper end - Add more Campfire API
+
+        if (nbt.contains("KioCG.CauldronTemperature", org.bukkit.craftbukkit.util.CraftMagicNumbers.NBT.TAG_INT)) cauldronTemperature = nbt.getInt("KioCG.CauldronTemperature"); // KioCG
     }
 
     @Override
@@ -248,6 +301,7 @@ public class CampfireBlockEntity extends BlockEntity implements Clearable {
         }
         nbt.putByteArray("Paper.StopCooking", cookingState);
         // Paper end - Add more Campfire API
+        nbt.putInt("KioCG.CauldronTemperature", cauldronTemperature); // KioCG
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/block/CraftCampfire.java b/src/main/java/org/bukkit/craftbukkit/block/CraftCampfire.java
index a776bba2ec51c6aecce98a3abceb2c235522d99d..2f59ee950ab8199374009cb65129f3a7c64f42b8 100644
--- a/src/main/java/org/bukkit/craftbukkit/block/CraftCampfire.java
+++ b/src/main/java/org/bukkit/craftbukkit/block/CraftCampfire.java
@@ -98,4 +98,11 @@ public class CraftCampfire extends CraftBlockEntityState<CampfireBlockEntity> im
         return getSnapshot().stopCooking[index];
     }
     // Paper end
+
+    // KioCG start
+    @Override
+    public boolean isCauldronBoiling() {
+        return getSnapshot().isCauldronBoiling();
+    }
+    // KioCG end
 }
