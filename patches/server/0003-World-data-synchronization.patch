From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Joket_abc <15005771700@qq.com>
Date: Thu, 4 Apr 2024 00:59:59 +0800
Subject: [PATCH] World data synchronization


diff --git a/src/main/java/net/minecraft/server/level/ServerLevel.java b/src/main/java/net/minecraft/server/level/ServerLevel.java
index 0981d440d0dbfe4df668d1f3f1b5706a93bc4434..cfa5499df1e50563d7cb8605fa56c9a28db1a9c0 100644
--- a/src/main/java/net/minecraft/server/level/ServerLevel.java
+++ b/src/main/java/net/minecraft/server/level/ServerLevel.java
@@ -1477,6 +1477,13 @@ public class ServerLevel extends Level implements WorldGenLevel {
         }
     }
 
+    // KioCG start
+    @Override
+    public long getDays() {
+        return this.serverLevelData.getDays();
+    }
+    // KioCG end
+
     @Override
     public boolean mayInteract(Player player, BlockPos pos) {
         return !this.server.isUnderSpawnProtection(this, pos, player) && this.getWorldBorder().isWithinBounds(pos);
diff --git a/src/main/java/net/minecraft/world/level/Level.java b/src/main/java/net/minecraft/world/level/Level.java
index b4ef3ad2c17168085372f1fe46809f02d9dfe74a..ed43bae7d06c816c284cfac82c5ad4dd30492828 100644
--- a/src/main/java/net/minecraft/world/level/Level.java
+++ b/src/main/java/net/minecraft/world/level/Level.java
@@ -1579,6 +1579,12 @@ public abstract class Level implements LevelAccessor, AutoCloseable {
         return this.levelData.getDayTime();
     }
 
+    // KioCG start
+    public long getDays() {
+        return 0;
+    }
+    // KioCG end
+
     public boolean mayInteract(Player player, BlockPos pos) {
         return true;
     }
diff --git a/src/main/java/net/minecraft/world/level/storage/PrimaryLevelData.java b/src/main/java/net/minecraft/world/level/storage/PrimaryLevelData.java
index efd0bcfebb3b4f63018d4e20a6a89f79192898d1..15fe9e6b34cf9ed4b88547261220104bc6499c3b 100644
--- a/src/main/java/net/minecraft/world/level/storage/PrimaryLevelData.java
+++ b/src/main/java/net/minecraft/world/level/storage/PrimaryLevelData.java
@@ -68,6 +68,7 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
     private float spawnAngle;
     private long gameTime;
     private long dayTime;
+    private long days; // KioCG
     @Nullable
     private final CompoundTag loadedPlayerTag;
     private final int version;
@@ -111,6 +112,7 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
         this.spawnAngle = spawnAngle;
         this.gameTime = time;
         this.dayTime = timeOfDay;
+        this.days = this.dayTime / 24000L; // KioCG
         this.version = version;
         this.clearWeatherTime = clearWeatherTime;
         this.rainTime = rainTime;
@@ -285,9 +287,23 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public long getDayTime() {
+        // KioCG start - 同步世界时间
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_DAYLIGHT)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).getDayTime();
+        }
+        // KioCG end - 同步世界时间
         return this.dayTime;
     }
 
+    // KioCG start
+    public long getDays() {
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_DAYLIGHT)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).getDays();
+        }
+        return this.days;
+    }
+    // KioCG end
+
     @Nullable
     @Override
     public CompoundTag getLoadedPlayerTag() {
@@ -302,6 +318,7 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
     @Override
     public void setDayTime(long timeOfDay) {
         this.dayTime = timeOfDay;
+        this.days = this.dayTime / 24000L; // KioCG
     }
 
     @Override
@@ -322,6 +339,11 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public int getClearWeatherTime() {
+        // KioCG start - 同步世界天气
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_WEATHER_CYCLE)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).getClearWeatherTime();
+        }
+        // KioCG end - 同步世界天气
         return this.clearWeatherTime;
     }
 
@@ -332,6 +354,11 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public boolean isThundering() {
+        // KioCG start - 同步世界天气
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_WEATHER_CYCLE)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).isThundering();
+        }
+        // KioCG end - 同步世界天气
         return this.thundering;
     }
 
@@ -361,6 +388,11 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public int getThunderTime() {
+        // KioCG start - 同步世界天气
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_WEATHER_CYCLE)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).getThunderTime();
+        }
+        // KioCG end - 同步世界天气
         return this.thunderTime;
     }
 
@@ -371,6 +403,11 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public boolean isRaining() {
+        // KioCG start - 同步世界天气
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_WEATHER_CYCLE)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).isRaining();
+        }
+        // KioCG end - 同步世界天气
         return this.raining;
     }
 
@@ -401,6 +438,11 @@ public class PrimaryLevelData implements ServerLevelData, WorldData {
 
     @Override
     public int getRainTime() {
+        // KioCG start - 同步世界天气
+        if (this != MinecraftServer.getServer().getWorldData() && this.getGameRules().getBoolean(GameRules.RULE_WEATHER_CYCLE)) {
+            return ((PrimaryLevelData) MinecraftServer.getServer().getWorldData()).getRainTime();
+        }
+        // KioCG end - 同步世界天气
         return this.rainTime;
     }
 
